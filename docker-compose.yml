services:
  database:
    image: mongo:6 # mongo 6 para computadores que no sean de apple y no rasberrys
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: password
    ports:
      - "27017:27017"
    volumes:
      - mongodata:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017 --quiet
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - suricata_network

  mongo-express:
    image: mongo-express
    container_name: mongo_express
    restart: always
    depends_on:
      - database
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: user
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_MONGODB_URL: mongodb://user:password@database:27017/
    networks:
      - suricata_network

  suricata:
    image: jasonish/suricata:latest
    container_name: suricata
    restart: unless-stopped
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_NICE
    network_mode: host
    environment:
      - NETWORK_INTERFACE=${NETWORK_INTERFACE}
    volumes:
      - ./suricata/suricata.yaml:/etc/suricata/suricata.yaml # Archivo de configuraciÃ³n
      - ./suricata/rules:/var/lib/suricata/rules # Reglas personalizadas
      - ./suricata/logs:/var/log/suricata # Logs de Suricata
    command: ["suricata", "-i", "${NETWORK_INTERFACE}"] ##depende de la interfaz de red eth0 wlan0
    entrypoint:
      [
        "/bin/bash",
        "-c",
        "ip link set dev ${NETWORK_INTERFACE} mtu 1500  && suricata -i ${NETWORK_INTERFACE}",
      ]

  fastapi:
    build: ./backend
    container_name: fastapi
    restart: always
    depends_on:
      database:
        condition: service_healthy
      suricata:
        condition: service_started
    ports:
      - "8000:8000"
    environment:
      MONGO_URI: mongodb://user:password@database:27017
    volumes:
      - ./suricata/rules:/var/lib/suricata/rules # Reglas personalizadas
      - ./suricata/logs:/var/log/suricata # Para leer logs en tiempo real
      - ./logs:/var/log # Nuevo volumen para los logs de FastAPI
      - ./backend/models:/app/models # ðŸ“Œ Guardar modelos fuera del contenedor
    networks:
      - suricata_network

  cron:
    build: ./cron
    container_name: cron
    restart: always
    depends_on:
      - fastapi
    volumes:
      - ./suricata/rules:/var/lib/suricata/rules # Para guardar reglas generadas
      - ./logs:/var/log # Para logs de cron
      - ./backend:/app # Para acceder a generate_rules.py
      - ./backend/models:/app/models # ðŸ“Œ Acceder a los modelos desde cron
    networks:
      - suricata_network

networks:
  suricata_network:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
      com.docker.network.driver.mtu: 1500 # Configurar el MTU de la red

volumes:
  mongodata:
  suricata_logs:
